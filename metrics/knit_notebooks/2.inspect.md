Inspect metrics
================

``` r
library(tidyverse)
library(glue)
library(logger)
```

``` r
type <- params$background_type
```

``` r
metric_set <- glue("level_1_0_{type}_null_adjusted")

parquet_file <-
  with(
    params,
    glue("{input_metrics_file_prefix}_{metric_set}.parquet")
  )

log_info("Reading {parquet_file} ...")

level_1_0_metrics_null_adjusted <-
  arrow::read_parquet(glue(parquet_file))

all_same_cols_rep <- attr(level_1_0_metrics_null_adjusted, "all_same_cols_rep")
```

After reading level_1, drop duplicates that may result from annotating
level 1_0 entities

``` r
metric_set <- glue("level_1_{type}_null_adjusted")

parquet_file <-
  with(
    params,
    glue("{input_metrics_file_prefix}_{metric_set}.parquet")
  )

log_info("Reading {parquet_file} ...")

level_1_metrics_null_adjusted <-
  arrow::read_parquet(glue(parquet_file)) %>%
  select(all_of(all_same_cols_rep), matches("^sim_")) %>%
  distinct()
```

``` r
significance_threshold <-
  attr(level_1_0_metrics_null_adjusted, "significance_threshold")

significance_threshold
```

    ## [1] 0.05

``` r
metric_list <-
  c(
    glue("sim_retrieval_average_precision_{type}_i_mean_i"),
    glue("sim_retrieval_average_precision_{type}_i_adjusted_mean_i"),
    glue("sim_retrieval_average_precision_{type}_i_nlog10pvalue_mean_i"),
    glue("sim_retrieval_average_precision_{type}_i_nlog10qvalue_mean_i")
  )
```

``` r
level_1_metrics_null_adjusted <-
  level_1_metrics_null_adjusted %>%
  select(matches("Metadata_"), one_of(metric_list)) %>%
  select(-Metadata_control_type, -Metadata_reference_or_other)
```

``` r
level_1_metrics_null_adjusted %>%
  count(Metadata_Perturbation, Metadata_Cell_type, Metadata_Time, Metadata_broad_sample) %>%
  filter(n > 1)
```

``` r
level_1_metrics_null_adjusted %>%
  ungroup() %>%
  slice_sample(n = 10) %>%
  rename(
    mAP = sim_retrieval_average_precision_ref_i_mean_i,
    mAP_adj = sim_retrieval_average_precision_ref_i_adjusted_mean_i,
    mAP_neglog10_pvalue = sim_retrieval_average_precision_ref_i_nlog10pvalue_mean_i,
    mAP_neglog10_qvalue = sim_retrieval_average_precision_ref_i_nlog10qvalue_mean_i
  )
```

<div class="kable-table">

| Metadata_Perturbation | Metadata_Cell_type | Metadata_Time | Metadata_target_list                                                             | Metadata_broad_sample  |       mAP |    mAP_adj | mAP_neglog10_pvalue | mAP_neglog10_qvalue |
|:----------------------|:-------------------|:--------------|:---------------------------------------------------------------------------------|:-----------------------|----------:|-----------:|--------------------:|--------------------:|
| compound              | U2OS               | 24            | CYP2A6\|CYP2B6\|CYP2C18\|CYP2C19\|CYP2C8\|CYP2C9\|CYP2D6\|CYP3A4\|CYP3A5\|CYP3A7 | BRD-A09722536-002-18-0 | 0.6784722 |  0.3536546 |           2.9328054 |           2.4340299 |
| crispr                | A549               | 96            | ITGB2                                                                            | BRDN0001489066         | 0.4880864 |  0.1967448 |           2.6213533 |           2.1783437 |
| crispr                | U2OS               | 96            | FFAR4                                                                            | BRDN0001486630         | 0.1421410 | -0.1634146 |           0.7061094 |           0.6547456 |
| orf                   | A549               | 48            | GPR55                                                                            | ccsbBroad304_02128     | 0.4190275 |  0.1134719 |           1.7940680 |           1.5318112 |
| compound              | U2OS               | 24            | FLT1\|FLT4\|KDR\|KIT                                                             | BRD-K99616396-316-05-3 | 1.0000000 |  0.6751824 |           4.0000434 |           3.2528681 |
| crispr                | A549               | 96            | AVPR1A                                                                           | BRDN0001490153         | 0.2537685 | -0.0517871 |           1.1478501 |           1.0126519 |
| compound              | A549               | 24            | ATP1A1\|CACNA1A\|CACNA1H\|CACNA2D2\|CALM1\|KCNQ1\|KCNQ4\|PDE1A\|PDE1B\|TNNC1     | BRD-A91008255-003-24-8 | 0.8847222 |  0.5744483 |           3.7500434 |           3.0650685 |
| crispr                | U2OS               | 144           | TNNC1                                                                            | BRDN0001483958         | 0.1793925 | -0.1261630 |           0.8377115 |           0.7642381 |
| compound              | A549               | 48            | HDAC6\|HDAC8                                                                     | BRD-K11558771-001-13-9 | 1.0000000 |  0.6897261 |           4.0000434 |           3.2528681 |
| orf                   | A549               | 48            | GJB4                                                                             | ccsbBroad304_04829     | 0.1901009 | -0.1154547 |           0.9686225 |           0.8711488 |

</div>

``` r
level_1_metrics_null_adjusted <-
  level_1_metrics_null_adjusted %>%
  inner_join(
    level_1_metrics_null_adjusted %>%
      distinct(Metadata_Perturbation, Metadata_Time) %>%
      arrange(Metadata_Perturbation, Metadata_Time) %>%
      group_by(Metadata_Perturbation) %>%
      mutate(Metadata_Time_coded = rank(Metadata_Time)) %>%
      ungroup() %>%
      mutate(Metadata_Time_coded = factor(
        Metadata_Time_coded, labels = c("short", "long")
      ))
  )
```

    ## Joining with `by = join_by(Metadata_Perturbation, Metadata_Time)`

``` r
level_1_metrics_null_adjusted %>%
  ggplot(aes(sim_retrieval_average_precision_ref_i_mean_i,
             sim_retrieval_average_precision_ref_i_nlog10qvalue_mean_i)) +
  geom_point() +
  facet_grid(Metadata_Perturbation ~ Metadata_Cell_type + Metadata_Time_coded) +
  geom_hline(yintercept = -log10(significance_threshold)) +
  theme_bw()
```

![](2.inspect_files/figure-gfm/unnamed-chunk-11-1.png)<!-- -->

``` r
level_1_metrics_null_adjusted %>%
  count(Metadata_Perturbation,
        Metadata_Cell_type,
        Metadata_Time)
```

<div class="kable-table">

| Metadata_Perturbation | Metadata_Cell_type | Metadata_Time |   n |
|:----------------------|:-------------------|:--------------|----:|
| compound              | A549               | 24            | 306 |
| compound              | A549               | 48            | 306 |
| compound              | U2OS               | 24            | 306 |
| compound              | U2OS               | 48            | 306 |
| crispr                | A549               | 96            | 305 |
| crispr                | A549               | 144           | 305 |
| crispr                | U2OS               | 96            | 305 |
| crispr                | U2OS               | 144           | 305 |
| orf                   | A549               | 48            | 160 |
| orf                   | A549               | 96            | 160 |
| orf                   | U2OS               | 48            | 160 |
| orf                   | U2OS               | 96            | 160 |

</div>

Based on `sim_retrieval_average_precision_ref_i_nlog10pvalue_mean_i`

``` r
level_1_metrics_null_adjusted %>%
  mutate(is_significant = sim_retrieval_average_precision_ref_i_nlog10pvalue_mean_i > 
           -log10(significance_threshold)) %>%
  count(Metadata_Perturbation,
        Metadata_Cell_type,
        Metadata_Time,
        is_significant) %>%
  pivot_wider(names_from = "is_significant", values_from = "n", names_prefix = "significant_") %>%
  mutate(frac_TRUE = round(significant_TRUE / (significant_TRUE + significant_FALSE), 2))
```

<div class="kable-table">

| Metadata_Perturbation | Metadata_Cell_type | Metadata_Time | significant_FALSE | significant_TRUE | frac_TRUE |
|:----------------------|:-------------------|:--------------|------------------:|-----------------:|----------:|
| compound              | A549               | 24            |                65 |              241 |      0.79 |
| compound              | A549               | 48            |                14 |              292 |      0.95 |
| compound              | U2OS               | 24            |                58 |              248 |      0.81 |
| compound              | U2OS               | 48            |                96 |              210 |      0.69 |
| crispr                | A549               | 96            |                84 |              221 |      0.72 |
| crispr                | A549               | 144           |                68 |              237 |      0.78 |
| crispr                | U2OS               | 96            |                79 |              226 |      0.74 |
| crispr                | U2OS               | 144           |               111 |              194 |      0.64 |
| orf                   | A549               | 48            |               116 |               44 |      0.28 |
| orf                   | A549               | 96            |               121 |               39 |      0.24 |
| orf                   | U2OS               | 48            |                73 |               87 |      0.54 |
| orf                   | U2OS               | 96            |                99 |               61 |      0.38 |

</div>

Based on `sim_retrieval_average_precision_ref_i_nlog10qvalue_mean_i`

``` r
level_1_metrics_null_adjusted %>%
  mutate(is_significant = sim_retrieval_average_precision_ref_i_nlog10qvalue_mean_i > 
           -log10(significance_threshold)) %>%
  count(Metadata_Perturbation,
        Metadata_Cell_type,
        Metadata_Time,
        is_significant) %>%
  pivot_wider(names_from = "is_significant", values_from = "n", names_prefix = "significant_") %>%
  mutate(frac_TRUE = round(significant_TRUE / (significant_TRUE + significant_FALSE), 2))
```

<div class="kable-table">

| Metadata_Perturbation | Metadata_Cell_type | Metadata_Time | significant_FALSE | significant_TRUE | frac_TRUE |
|:----------------------|:-------------------|:--------------|------------------:|-----------------:|----------:|
| compound              | A549               | 24            |                79 |              227 |      0.74 |
| compound              | A549               | 48            |                23 |              283 |      0.92 |
| compound              | U2OS               | 24            |                76 |              230 |      0.75 |
| compound              | U2OS               | 48            |               107 |              199 |      0.65 |
| crispr                | A549               | 96            |                98 |              207 |      0.68 |
| crispr                | A549               | 144           |                97 |              208 |      0.68 |
| crispr                | U2OS               | 96            |                98 |              207 |      0.68 |
| crispr                | U2OS               | 144           |               141 |              164 |      0.54 |
| orf                   | A549               | 48            |               127 |               33 |      0.21 |
| orf                   | A549               | 96            |               131 |               29 |      0.18 |
| orf                   | U2OS               | 48            |                89 |               71 |      0.44 |
| orf                   | U2OS               | 96            |               108 |               52 |      0.32 |

</div>

Based on `sim_retrieval_average_precision_ref_i_adjusted_mean_i`

``` r
level_1_metrics_null_adjusted %>%
  mutate(is_significant = sim_retrieval_average_precision_ref_i_adjusted_mean_i > 0) %>%
  count(Metadata_Perturbation,
        Metadata_Cell_type,
        Metadata_Time,
        is_significant) %>%
  pivot_wider(names_from = "is_significant", values_from = "n", names_prefix = "significant_") %>%
  mutate(frac_TRUE = round(significant_TRUE / (significant_TRUE + significant_FALSE), 2))
```

<div class="kable-table">

| Metadata_Perturbation | Metadata_Cell_type | Metadata_Time | significant_FALSE | significant_TRUE | frac_TRUE |
|:----------------------|:-------------------|:--------------|------------------:|-----------------:|----------:|
| compound              | A549               | 24            |                71 |              235 |      0.77 |
| compound              | A549               | 48            |                17 |              289 |      0.94 |
| compound              | U2OS               | 24            |                63 |              243 |      0.79 |
| compound              | U2OS               | 48            |               103 |              203 |      0.66 |
| crispr                | A549               | 96            |                88 |              217 |      0.71 |
| crispr                | A549               | 144           |                80 |              225 |      0.74 |
| crispr                | U2OS               | 96            |                84 |              221 |      0.72 |
| crispr                | U2OS               | 144           |               117 |              188 |      0.62 |
| orf                   | A549               | 48            |               121 |               39 |      0.24 |
| orf                   | A549               | 96            |               123 |               37 |      0.23 |
| orf                   | U2OS               | 48            |                83 |               77 |      0.48 |
| orf                   | U2OS               | 96            |               101 |               59 |      0.37 |

</div>
