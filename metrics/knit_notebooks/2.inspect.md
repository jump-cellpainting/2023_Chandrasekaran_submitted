Inspect metrics
================

``` r
library(tidyverse)
library(glue)
library(logger)
```

``` r
type <- params$background_type
```

``` r
metric_set <- glue("level_1_0_{type}_null_adjusted")

parquet_file <-
  with(
    params,
    glue("{input_metrics_file_prefix}_{metric_set}.parquet")
  )

log_info("Reading {parquet_file} ...")

level_1_0_metrics_null_adjusted <-
  arrow::read_parquet(glue(parquet_file))

all_same_cols_rep <- attr(level_1_0_metrics_null_adjusted, "all_same_cols_rep")
```

After reading level_1, drop duplicates that may result from annotating
level 1_0 entities

``` r
metric_set <- glue("level_1_{type}_null_adjusted")

parquet_file <-
  with(
    params,
    glue("{input_metrics_file_prefix}_{metric_set}.parquet")
  )

log_info("Reading {parquet_file} ...")

level_1_metrics_null_adjusted <-
  arrow::read_parquet(glue(parquet_file)) %>%
  select(all_of(all_same_cols_rep), matches("^sim_")) %>%
  distinct()
```

``` r
significance_threshold <-
  attr(level_1_0_metrics_null_adjusted, "significance_threshold")

significance_threshold
```

    ## [1] 0.05

``` r
metric_list <-
  c(
    glue("sim_retrieval_average_precision_{type}_i_mean_i"),
    glue("sim_retrieval_average_precision_{type}_i_nlog10pvalue_mean_i")
  )
```

``` r
level_1_metrics_null_adjusted <-
  level_1_metrics_null_adjusted %>%
  select(matches("Metadata_"), one_of(metric_list)) %>%
  select(-Metadata_control_type, -Metadata_reference_or_other)
```

``` r
level_1_metrics_null_adjusted %>%
  count(Metadata_Perturbation, Metadata_Cell_type, Metadata_Time, Metadata_broad_sample) %>%
  filter(n > 1)
```

<div class="kable-table">

|                                                                                |
|--------------------------------------------------------------------------------|
| Metadata_Perturbation Metadata_Cell_type Metadata_Time Metadata_broad_sample n |

| :                                                                                                                                                                                                          |
|:-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Metadata_Perturbation Metadata_Cell_type Metadata_Time Metadata_target_list Metadata_broad_sample sim_retrieval_average_precision_ref_i\_mean_i sim_retrieval_average_precision_ref_i\_nlog10pvalue_mean_i |

crispr A549 144 ELANE BRDN0001483830 0.3682389 1.6623897

compound U2OS 48 BRAF BRD-K62810658-001-11-4 0.5491071 2.2884455

orf A549 48 HPGDS ccsbBroad304_03026 0.3294643 1.5541891

compound A549 48 LPAR1 BRD-K26439554-001-01-3 0.5426587 2.3957067

crispr U2OS 144 CATSPER4 BRDN0001484586 0.6157585 2.6691788

compound U2OS 48 SIRT2 BRD-K16472653-001-01-6 0.4531323 1.9641252

orf U2OS 96 KCTD16 ccsbBroad304_03827 0.0774372 0.3615740

orf A549 96 RET ccsbBroad304_14827 0.1170423 0.5936644

crispr U2OS 96 GAA BRDN0001487440 0.2626890 1.2007366

crispr A549 96 DCK BRDN0001487070 0.2160486 1.0798352
————————————————————————————————————————————————————————————————————————-

</div>

``` r
level_1_metrics_null_adjusted <-
  level_1_metrics_null_adjusted %>%
  inner_join(
    level_1_metrics_null_adjusted %>%
      distinct(Metadata_Perturbation, Metadata_Time) %>%
      arrange(Metadata_Perturbation, Metadata_Time) %>%
      group_by(Metadata_Perturbation) %>%
      mutate(Metadata_Time_coded = rank(Metadata_Time)) %>%
      ungroup() %>%
      mutate(Metadata_Time_coded = factor(
        Metadata_Time_coded, labels = c("short", "long")
      ))
  )
```

    ## Joining with `by = join_by(Metadata_Perturbation, Metadata_Time)`

``` r
level_1_metrics_null_adjusted %>%
  ggplot(aes(sim_retrieval_average_precision_ref_i_mean_i,
             sim_retrieval_average_precision_ref_i_nlog10pvalue_mean_i)) +
  geom_point() +
  facet_grid(Metadata_Perturbation ~ Metadata_Cell_type + Metadata_Time_coded) +
  geom_hline(yintercept = -log10(significance_threshold)) +
  theme_bw()
```

![](2.inspect_files/figure-gfm/unnamed-chunk-11-1.png)<!-- -->
